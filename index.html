<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KantinSehat - Aplikasi Kantin Sekolah</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel Export (Simulated) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Tema Custom */
        .theme-pink { --bg: #fdf2f8; --text: #831843; --primary: #db2777; --secondary: #fbcfe8; }
        .theme-galaxy { --bg: #0f172a; --text: #e2e8f0; --primary: #8b5cf6; --secondary: #1e293b; }
        .theme-retro { --bg: #fef3c7; --text: #78350f; --primary: #d97706; --secondary: #fffbeb; }
        .theme-minimalis { --bg: #ffffff; --text: #1f2937; --primary: #3b82f6; --secondary: #f3f4f6; }
        .theme-dark { --bg: #18181b; --text: #fafafa; --primary: #10b981; --secondary: #27272a; }

        body.theme-pink { background-color: var(--bg); color: var(--text); }
        body.theme-galaxy { background-color: var(--bg); color: var(--text); }
        body.theme-retro { background-color: var(--bg); color: var(--text); }
        body.theme-minimalis { background-color: var(--bg); color: var(--text); }
        body.theme-dark { background-color: var(--bg); color: var(--text); }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .card { background-color: var(--secondary); border: 1px solid rgba(0,0,0,0.05); }
        .text-primary { color: var(--primary); }
        
        /* Animasi */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Modal Background */
        .modal-bg { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="theme-minimalis min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="p-4 shadow-md card sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-utensils text-2xl text-primary"></i>
                <h1 class="text-xl font-bold tracking-wide">Kantin<span class="text-primary">Sehat</span></h1>
            </div>
            <div id="nav-actions" class="flex items-center gap-4">
                <!-- Theme Selector -->
                <select id="theme-selector" onchange="changeTheme(this.value)" class="p-1 rounded border text-xs text-black">
                    <option value="theme-minimalis">Minimalis</option>
                    <option value="theme-pink">Pink</option>
                    <option value="theme-galaxy">Galaxy</option>
                    <option value="theme-retro">Retro</option>
                    <option value="theme-dark">Dark Mode</option>
                </select>
                <div id="user-info" class="hidden flex items-center gap-2">
                    <span id="welcome-msg" class="font-semibold text-sm hidden md:inline"></span>
                    <button onclick="logout()" class="text-red-500 hover:text-red-700 ml-2" title="Keluar"><i class="fas fa-sign-out-alt text-lg"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="app" class="flex-grow container mx-auto p-4 relative">
        <!-- Views will be injected here via JavaScript -->
    </main>

    <!-- Footer -->
    <footer class="p-4 text-center text-sm opacity-70">
        &copy; 2025 KantinSehat | Sehat, Cepat, Hemat
    </footer>

    <!-- Templates (Hidden) -->
    
    <!-- 1. LOGIN & REGISTER VIEW -->
    <template id="view-auth">
        <div class="max-w-md mx-auto mt-10 card p-8 rounded-xl shadow-lg fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold mb-2">Selamat Datang</h2>
                <p class="text-sm opacity-70">Silakan login untuk memesan atau mengelola kantin.</p>
            </div>

            <!-- Tabs -->
            <div class="flex mb-4 border-b border-gray-300">
                <button onclick="switchAuthTab('login')" id="tab-login" class="w-1/2 py-2 font-semibold text-primary border-b-2 border-primary">Login</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="w-1/2 py-2 opacity-60 hover:opacity-100">Daftar Admin</button>
            </div>

            <!-- Login Form -->
            <form id="form-login" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm mb-1">Username / NISN</label>
                    <input type="text" id="login-username" class="w-full p-2 rounded border text-black" required>
                </div>
                <div>
                    <label class="block text-sm mb-1">Password</label>
                    <div class="relative">
                        <input type="password" id="login-password" class="w-full p-2 rounded border text-black" required>
                        <button type="button" onclick="togglePassword('login-password')" class="absolute right-2 top-2 text-gray-500"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <button type="submit" class="w-full btn-primary py-2 rounded-lg font-bold shadow-md transform hover:scale-105 transition">Masuk</button>
            </form>

            <!-- Register Form (Admin Only) -->
            <form id="form-register" onsubmit="handleRegister(event)" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm mb-1">Nama Lengkap</label>
                    <input type="text" id="reg-name" class="w-full p-2 rounded border text-black" required>
                </div>
                <div>
                    <label class="block text-sm mb-1">Username Admin</label>
                    <input type="text" id="reg-username" class="w-full p-2 rounded border text-black" required>
                </div>
                <div>
                    <label class="block text-sm mb-1">Password</label>
                    <div class="relative">
                        <input type="password" id="reg-password" class="w-full p-2 rounded border text-black" required>
                        <button type="button" onclick="togglePassword('reg-password')" class="absolute right-2 top-2 text-gray-500"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg font-bold shadow-md hover:bg-green-600">Daftar Sebagai Admin</button>
            </form>
        </div>
    </template>

    <!-- 2. ADMIN DASHBOARD -->
    <template id="view-admin">
        <div class="fade-in">
            <h2 class="text-2xl font-bold mb-4">Dashboard Admin</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="card p-4 rounded-lg shadow cursor-pointer hover:bg-opacity-80 transition" onclick="renderAdminUsers()">
                    <div class="text-3xl text-blue-500 mb-2"><i class="fas fa-users-cog"></i></div>
                    <h3 class="font-bold">Kelola Pengguna</h3>
                    <p class="text-xs opacity-70">Tambah Penjual & Siswa</p>
                </div>
                <div class="card p-4 rounded-lg shadow cursor-pointer hover:bg-opacity-80 transition" onclick="renderAdminReports()">
                    <div class="text-3xl text-green-500 mb-2"><i class="fas fa-chart-line"></i></div>
                    <h3 class="font-bold">Laporan</h3>
                    <p class="text-xs opacity-70">Transaksi & Export</p>
                </div>
                <div class="card p-4 rounded-lg shadow cursor-pointer hover:bg-opacity-80 transition" onclick="renderLeaderboard()">
                    <div class="text-3xl text-yellow-500 mb-2"><i class="fas fa-trophy"></i></div>
                    <h3 class="font-bold">Leaderboard</h3>
                    <p class="text-xs opacity-70">Top 3 Penjual</p>
                </div>
                 <div class="card p-4 rounded-lg shadow cursor-pointer hover:bg-opacity-80 transition" onclick="renderAdminSettings()">
                    <div class="text-3xl text-gray-500 mb-2"><i class="fas fa-cogs"></i></div>
                    <h3 class="font-bold">Pengaturan</h3>
                    <p class="text-xs opacity-70">Reset Data</p>
                </div>
            </div>
            
            <div id="admin-content" class="card p-6 rounded-lg shadow min-h-[300px]">
                <!-- Dynamic Content Here -->
            </div>
        </div>
    </template>

    <!-- 3. SELLER DASHBOARD (UPDATED) -->
    <template id="view-seller">
        <div class="fade-in relative">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-2">
                <div>
                    <h2 class="text-2xl font-bold">Dashboard Penjual</h2>
                    <p class="text-sm opacity-70">Kelola menu dan pesanan Anda di sini.</p>
                </div>
                <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg text-sm font-bold shadow-sm" id="seller-revenue">
                    <i class="fas fa-wallet mr-2"></i>Omzet: Rp 0
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button onclick="renderSellerMenu()" class="card p-4 rounded-lg hover:shadow-lg text-left border-l-4 border-blue-500 transition transform hover:-translate-y-1">
                    <h3 class="font-bold text-lg"><i class="fas fa-hamburger mr-2"></i>Menu Saya</h3>
                    <p class="text-xs mt-1 opacity-70">Tambah & edit makanan</p>
                </button>
                <button onclick="renderSellerOrders()" class="card p-4 rounded-lg hover:shadow-lg text-left border-l-4 border-yellow-500 relative transition transform hover:-translate-y-1">
                    <h3 class="font-bold text-lg"><i class="fas fa-bell mr-2"></i>Pesanan</h3>
                    <p class="text-xs mt-1 opacity-70">Konfirmasi pesanan masuk</p>
                    <span id="incoming-order-badge" class="absolute top-3 right-3 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow animate-pulse hidden">0</span>
                </button>
                <button onclick="renderLeaderboard()" class="card p-4 rounded-lg hover:shadow-lg text-left border-l-4 border-purple-500 transition transform hover:-translate-y-1">
                    <h3 class="font-bold text-lg"><i class="fas fa-chart-bar mr-2"></i>Peringkat</h3>
                    <p class="text-xs mt-1 opacity-70">Lihat posisi penjualan</p>
                </button>
            </div>

            <div id="seller-content" class="card p-6 rounded-lg shadow min-h-[400px]">
                <!-- Content -->
            </div>

            <!-- MODAL TAMBAH MENU (NEW) -->
            <div id="modal-menu" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-bounce-in">
                    <div class="bg-primary p-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i class="fas fa-plus-circle mr-2"></i>Tambah Menu Baru</h3>
                        <button onclick="closeMenuModal()" class="hover:text-red-200 transition"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleSaveMenu(event)" class="p-6 space-y-4 text-gray-800">
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">Nama Makanan/Minuman</label>
                            <input type="text" id="menu-name" class="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: Nasi Goreng Sehat" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 text-gray-700">Harga (Rp)</label>
                                <input type="number" id="menu-price" class="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 text-gray-700">Stok Awal</label>
                                <input type="number" id="menu-stock" class="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">Kategori</label>
                            <select id="menu-category" class="w-full border border-gray-300 p-2.5 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="sehat">ü•ó Makanan Sehat</option>
                                <option value="ringan">üç™ Snack / Ringan</option>
                                <option value="minuman">ü•§ Minuman</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">Link Foto (Opsional)</label>
                            <input type="text" id="menu-image" class="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://...">
                            <p class="text-xs text-gray-400 mt-1">Kosongkan untuk menggunakan gambar default.</p>
                        </div>
                        <div class="pt-2">
                            <button type="submit" class="w-full btn-primary py-3 rounded-lg font-bold shadow hover:shadow-lg transition">Simpan Menu</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </template>

    <!-- 4. BUYER DASHBOARD -->
    <template id="view-buyer">
        <div class="fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Mau makan apa hari ini?</h2>
                    <p class="text-sm opacity-70">Pilih makanan sehat untuk energi belajarmu!</p>
                </div>
                <div class="flex items-center gap-3 self-end">
                    <button onclick="renderBuyerHistory()" class="text-sm font-semibold underline hover:text-primary">Riwayat</button>
                    <button onclick="renderBuyerCart()" class="btn-primary px-5 py-2.5 rounded-full shadow-lg relative transform hover:scale-105 transition">
                        <i class="fas fa-shopping-cart mr-1"></i> Keranjang
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs border-2 border-white font-bold hidden">0</span>
                    </button>
                </div>
            </div>

            <!-- Categories -->
            <div class="flex gap-2 overflow-x-auto pb-4 mb-2 no-scrollbar">
                <button onclick="filterMenu('all')" class="px-5 py-2 rounded-full bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm font-semibold whitespace-nowrap transition">Semua</button>
                <button onclick="filterMenu('sehat')" class="px-5 py-2 rounded-full bg-green-100 text-green-700 hover:bg-green-200 text-sm font-semibold whitespace-nowrap transition"><i class="fas fa-leaf mr-1"></i>Sehat</button>
                <button onclick="filterMenu('ringan')" class="px-5 py-2 rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200 text-sm font-semibold whitespace-nowrap transition"><i class="fas fa-cookie mr-1"></i>Ringan</button>
                <button onclick="filterMenu('minuman')" class="px-5 py-2 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 text-sm font-semibold whitespace-nowrap transition"><i class="fas fa-glass-water mr-1"></i>Minuman</button>
            </div>

            <div id="buyer-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 pb-20">
                <!-- Menu Items -->
            </div>
        </div>
    </template>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATABASE & STATE ---
        const DB_KEYS = { USERS: 'ks_users', PRODUCTS: 'ks_products', ORDERS: 'ks_orders', SETTINGS: 'ks_settings' };
        
        let state = {
            user: null, 
            cart: [],
            view: 'auth'
        };

        // --- UTILS ---
        const loadData = (key) => JSON.parse(localStorage.getItem(key)) || [];
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const getEl = (id) => document.getElementById(id);

        // --- INITIALIZATION ---
        function init() {
            // Setup Default Admin if empty
            const users = loadData(DB_KEYS.USERS);
            if (users.length === 0) {
                // Auto create default admin for first usage
                // No action needed, user will register
            }

            const sessionUser = sessionStorage.getItem('ks_session');
            if (sessionUser) {
                state.user = JSON.parse(sessionUser);
                renderApp();
            } else {
                renderView('auth');
            }
            
            const settings = JSON.parse(localStorage.getItem(DB_KEYS.SETTINGS)) || { theme: 'theme-minimalis' };
            changeTheme(settings.theme, false);
            const selector = getEl('theme-selector');
            if(selector) selector.value = settings.theme;
        }

        function changeTheme(themeName, save = true) {
            document.body.className = `${themeName} min-h-screen flex flex-col`;
            if (save) {
                const settings = JSON.parse(localStorage.getItem(DB_KEYS.SETTINGS)) || {};
                settings.theme = themeName;
                saveData(DB_KEYS.SETTINGS, settings);
            }
        }

        // --- AUTHENTICATION ---
        function switchAuthTab(tab) {
            const loginForm = getEl('form-login');
            const regForm = getEl('form-register');
            const tabLogin = getEl('tab-login');
            const tabReg = getEl('tab-register');

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');
                tabLogin.className = "w-1/2 py-2 font-semibold text-primary border-b-2 border-primary";
                tabReg.className = "w-1/2 py-2 opacity-60 hover:opacity-100";
            } else {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                tabLogin.className = "w-1/2 py-2 opacity-60 hover:opacity-100";
                tabReg.className = "w-1/2 py-2 font-semibold text-primary border-b-2 border-primary";
            }
        }

        function togglePassword(inputId) {
            const input = getEl(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = getEl('reg-name').value;
            const username = getEl('reg-username').value;
            const password = getEl('reg-password').value;

            const users = loadData(DB_KEYS.USERS);
            if (users.find(u => u.username === username)) {
                alert('Username sudah terpakai!');
                return;
            }

            const newUser = { id: generateId(), name, username, password, role: 'admin' };
            users.push(newUser);
            saveData(DB_KEYS.USERS, users);
            alert('Pendaftaran Admin Berhasil! Silakan Login.');
            switchAuthTab('login');
            getEl('form-register').reset();
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = getEl('login-username').value;
            const password = getEl('login-password').value;
            const users = loadData(DB_KEYS.USERS);

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                state.user = user;
                sessionStorage.setItem('ks_session', JSON.stringify(user));
                renderApp();
            } else {
                alert('Username atau password salah!');
            }
        }

        function logout() {
            state.user = null;
            state.cart = [];
            sessionStorage.removeItem('ks_session');
            renderView('auth');
            getEl('user-info').classList.add('hidden');
        }

        // --- CORE RENDERING ---
        function renderApp() {
            getEl('user-info').classList.remove('hidden');
            getEl('welcome-msg').innerText = `Halo, ${state.user.name} (${state.user.role})`;
            
            if (state.user.role === 'admin') renderView('admin');
            else if (state.user.role === 'penjual') renderView('seller');
            else if (state.user.role === 'siswa') renderView('buyer');
        }

        function renderView(viewName) {
            const app = getEl('app');
            const template = getEl(`view-${viewName}`);
            app.innerHTML = '';
            app.appendChild(template.content.cloneNode(true));

            if (viewName === 'admin') renderAdminUsers();
            if (viewName === 'seller') {
                renderSellerMenu();
                updateIncomingOrdersBadge();
            }
            if (viewName === 'buyer') renderBuyerMenu();
            
            // Re-apply theme selector value just in case
            const settings = JSON.parse(localStorage.getItem(DB_KEYS.SETTINGS)) || { theme: 'theme-minimalis' };
            const selector = getEl('theme-selector');
            if(selector) selector.value = settings.theme;
        }

        // --- ADMIN FEATURES ---
        function renderAdminUsers() {
            const container = getEl('admin-content');
            container.innerHTML = `
                <h3 class="font-bold text-lg mb-4 text-gray-700">Tambah Pengguna Baru</h3>
                <form onsubmit="adminAddUser(event)" class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-8 shadow-inner">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="new-name" placeholder="Nama Lengkap" class="p-2 border rounded text-black outline-none focus:ring-2 focus:ring-blue-400" required>
                        <input type="text" id="new-username" placeholder="Username / NISN" class="p-2 border rounded text-black outline-none focus:ring-2 focus:ring-blue-400" required>
                        <div class="relative">
                            <input type="password" id="new-password" placeholder="Password" class="w-full p-2 border rounded text-black outline-none focus:ring-2 focus:ring-blue-400" required>
                             <button type="button" onclick="togglePassword('new-password')" class="absolute right-2 top-2 text-gray-500"><i class="fas fa-eye"></i></button>
                        </div>
                        <select id="new-role" class="p-2 border rounded text-black outline-none focus:ring-2 focus:ring-blue-400" onchange="toggleKelasField(this.value)">
                            <option value="penjual">Penjual</option>
                            <option value="siswa">Siswa / Pembeli</option>
                        </select>
                        <input type="text" id="new-kelas" placeholder="Kelas (Wajib untuk siswa)" class="p-2 border rounded hidden text-black outline-none focus:ring-2 focus:ring-blue-400 col-span-2 md:col-span-1">
                    </div>
                    <button type="submit" class="btn-primary w-full mt-4 p-2 rounded font-bold shadow hover:shadow-md transition">Simpan Pengguna</button>
                </form>

                <h3 class="font-bold text-lg mb-2 text-gray-700">Daftar Pengguna</h3>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="w-full text-left text-sm bg-white">
                        <thead class="bg-gray-100 text-gray-700 uppercase font-semibold">
                            <tr><th class="p-3">Nama</th><th class="p-3">Username</th><th class="p-3">Role</th><th class="p-3">Aksi</th></tr>
                        </thead>
                        <tbody id="user-list-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            `;
            loadUserList();
        }

        function toggleKelasField(role) {
            const kelasInput = getEl('new-kelas');
            if (role === 'siswa') kelasInput.classList.remove('hidden');
            else kelasInput.classList.add('hidden');
        }

        function adminAddUser(e) {
            e.preventDefault();
            const users = loadData(DB_KEYS.USERS);
            const username = getEl('new-username').value;
            
            if (users.find(u => u.username === username)) {
                alert('Username sudah ada!');
                return;
            }

            const newUser = {
                id: generateId(),
                name: getEl('new-name').value,
                username: username,
                password: getEl('new-password').value,
                role: getEl('new-role').value,
                kelas: getEl('new-kelas').value || '-'
            };

            users.push(newUser);
            saveData(DB_KEYS.USERS, users);
            alert('Pengguna berhasil ditambahkan!');
            e.target.reset();
            loadUserList();
        }

        function loadUserList() {
            const users = loadData(DB_KEYS.USERS).filter(u => u.role !== 'admin');
            const tbody = getEl('user-list-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center opacity-50">Belum ada data pengguna.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(u => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-3">${u.name}</td>
                    <td class="p-3 font-mono text-xs text-gray-600">${u.username}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-bold ${u.role === 'penjual' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}">${u.role.toUpperCase()}</span></td>
                    <td class="p-3"><button onclick="deleteUser('${u.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function deleteUser(id) {
            if(!confirm('Hapus pengguna ini?')) return;
            let users = loadData(DB_KEYS.USERS);
            users = users.filter(u => u.id !== id);
            saveData(DB_KEYS.USERS, users);
            loadUserList();
        }

        function renderAdminReports() {
            const orders = loadData(DB_KEYS.ORDERS);
            const totalRevenue = orders.reduce((sum, o) => sum + o.total, 0);
            
            getEl('admin-content').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-gray-700">Laporan Penjualan</h3>
                    <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center gap-2">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div class="p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border border-green-200 shadow-sm">
                        <div class="text-sm text-green-700 font-semibold uppercase tracking-wider mb-1">Total Transaksi</div>
                        <div class="text-4xl font-bold text-green-900">${orders.length}</div>
                    </div>
                    <div class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200 shadow-sm">
                        <div class="text-sm text-blue-700 font-semibold uppercase tracking-wider mb-1">Total Pendapatan</div>
                        <div class="text-4xl font-bold text-blue-900">${formatRupiah(totalRevenue)}</div>
                    </div>
                </div>
                
                <h4 class="font-bold mb-3 text-gray-700">Riwayat Transaksi Terakhir</h4>
                <div class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto border border-gray-200">
                    <ul class="text-sm space-y-2">
                        ${orders.length === 0 ? '<p class="text-center opacity-50">Belum ada data.</p>' : 
                          orders.slice(0, 10).map(o => `
                            <li class="bg-white p-3 rounded shadow-sm flex justify-between items-center border border-gray-100">
                                <div>
                                    <span class="font-bold block text-gray-800">Order #${o.id.substr(0,5)}</span>
                                    <span class="text-xs text-gray-500">${new Date(o.date).toLocaleDateString()} - ${o.buyerName}</span>
                                </div>
                                <span class="font-bold text-primary">${formatRupiah(o.total)}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        function renderAdminSettings() {
             getEl('admin-content').innerHTML = `
                <h3 class="font-bold text-xl mb-4 text-gray-700">Pengaturan Sistem</h3>
                <div class="p-6 bg-red-50 border border-red-200 rounded-xl">
                    <div class="flex items-start gap-4">
                        <div class="bg-red-100 p-3 rounded-full text-red-600"><i class="fas fa-exclamation-triangle text-xl"></i></div>
                        <div>
                            <h4 class="text-red-800 font-bold mb-1 text-lg">Zona Bahaya (Reset Data)</h4>
                            <p class="text-sm text-red-600 mb-4 leading-relaxed">Tindakan ini akan menghapus <strong>SEMUA</strong> data termasuk:
                            <br>‚Ä¢ Semua Menu Makanan
                            <br>‚Ä¢ Semua Riwayat Transaksi
                            <br>‚Ä¢ Semua Akun User (kecuali akun Admin Anda saat ini)</p>
                            <button onclick="resetSystem()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-bold shadow transition">Reset Semua Data</button>
                        </div>
                    </div>
                </div>
             `;
        }

        function resetSystem() {
            const confirmation = prompt("Ketik 'RESET' untuk menghapus semua data.");
            if (confirmation === 'RESET') {
                const currentAdmin = state.user;
                localStorage.clear();
                // Restore current admin
                saveData(DB_KEYS.USERS, [currentAdmin]);
                saveData(DB_KEYS.SETTINGS, {theme: 'theme-minimalis'});
                alert("Sistem berhasil direset.");
                location.reload();
            }
        }

        function exportToExcel() {
            const orders = loadData(DB_KEYS.ORDERS);
            const data = orders.map(o => ({
                ID: o.id,
                Tanggal: new Date(o.date).toLocaleString(),
                Pembeli: o.buyerName,
                Penjual: o.sellerName,
                Total: o.total,
                Status: o.status
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Penjualan");
            XLSX.writeFile(wb, "Laporan_KantinSehat.xlsx");
        }

        // --- SELLER FEATURES (REVISED) ---
        function renderSellerMenu() {
            const container = getEl('seller-content');
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-gray-800">Daftar Menu Makanan</h3>
                    <button onclick="openAddMenuModal()" class="btn-primary px-4 py-2 rounded-lg text-sm shadow flex items-center gap-2 hover:bg-opacity-90 transition">
                        <i class="fas fa-plus"></i> Tambah Menu
                    </button>
                </div>
                <div id="my-menu-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4"></div>
            `;
            loadSellerMenu();
        }

        function loadSellerMenu() {
            const products = loadData(DB_KEYS.PRODUCTS).filter(p => p.sellerId === state.user.id);
            const list = getEl('my-menu-list');
            
            if (products.length === 0) {
                list.innerHTML = `
                    <div class="col-span-full text-center py-10 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <i class="fas fa-utensils text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">Anda belum memiliki menu.</p>
                        <p class="text-sm text-gray-400">Klik tombol "Tambah Menu" di atas.</p>
                    </div>`;
                return;
            }

            list.innerHTML = products.map(p => `
                <div class="flex items-start gap-4 p-4 border rounded-xl bg-white shadow-sm hover:shadow-md transition group relative">
                    <div class="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden border">
                        ${p.image ? `<img src="${p.image}" onerror="this.onerror=null; this.src='https://placehold.co/80x80/cccccc/333333?text=Menu';" class="w-full h-full object-cover">` : '<span class="text-3xl">üç≤</span>'}
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800 line-clamp-1">${p.name}</h4>
                            <button onclick="deleteProduct('${p.id}')" class="text-gray-400 hover:text-red-500 transition p-1"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="flex items-center gap-2 mt-1 mb-2">
                             <span class="text-xs px-2 py-0.5 rounded-full ${p.category === 'sehat' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'} capitalize">
                                ${p.category}
                             </span>
                             <span class="text-xs text-gray-500">Stok: <b>${p.stock}</b></span>
                        </div>
                        <div class="text-primary font-bold text-lg">${formatRupiah(p.price)}</div>
                    </div>
                </div>
            `).join('');
        }

        // --- NEW MODAL LOGIC ---
        function openAddMenuModal() {
            const modal = getEl('modal-menu');
            modal.classList.remove('hidden');
            // Reset form
            getEl('menu-name').value = '';
            getEl('menu-price').value = '';
            getEl('menu-stock').value = '';
            getEl('menu-image').value = '';
            getEl('menu-category').value = 'sehat';
        }

        function closeMenuModal() {
            getEl('modal-menu').classList.add('hidden');
        }

        function handleSaveMenu(e) {
            e.preventDefault();
            const name = getEl('menu-name').value;
            const price = parseInt(getEl('menu-price').value);
            const stock = parseInt(getEl('menu-stock').value);
            const category = getEl('menu-category').value;
            const image = getEl('menu-image').value;

            if(!name || !price || !stock) {
                alert("Mohon lengkapi data!");
                return;
            }

            const newProduct = {
                id: generateId(),
                sellerId: state.user.id,
                sellerName: state.user.name,
                name,
                price,
                stock,
                category,
                image
            };

            const products = loadData(DB_KEYS.PRODUCTS);
            products.push(newProduct);
            saveData(DB_KEYS.PRODUCTS, products);

            closeMenuModal();
            renderSellerMenu();
            
            // Show success animation or toast could be added here
        }

        function deleteProduct(id) {
            if(!confirm('Hapus menu ini dari daftar?')) return;
            let products = loadData(DB_KEYS.PRODUCTS);
            products = products.filter(p => p.id !== id);
            saveData(DB_KEYS.PRODUCTS, products);
            loadSellerMenu();
        }

        function renderSellerOrders() {
            const container = getEl('seller-content');
            const orders = loadData(DB_KEYS.ORDERS).filter(o => o.sellerId === state.user.id).reverse();

            container.innerHTML = `
                <div class="mb-4">
                    <h3 class="font-bold text-xl text-gray-800">Pesanan Masuk</h3>
                    <p class="text-sm text-gray-500">Konfirmasi pesanan agar siswa dapat mengambil makanan.</p>
                </div>
            `;
            
            if(orders.length === 0) {
                container.innerHTML += `<div class="text-center py-10 opacity-50 border-2 border-dashed rounded-lg"><i class="fas fa-bell-slash text-4xl mb-2"></i><br>Belum ada pesanan masuk.</div>`;
                return;
            }

            orders.forEach(o => {
                const itemHtml = o.items.map(i => `
                    <div class="flex justify-between text-sm py-1 border-b border-gray-100 last:border-0">
                        <span><span class="font-bold text-gray-700">${i.qty}x</span> ${i.name}</span>
                        <span class="text-gray-500">${formatRupiah(i.price * i.qty)}</span>
                    </div>
                `).join('');
                
                const isPending = o.status === 'pending';
                const statusBadge = isPending 
                    ? `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"><i class="fas fa-clock"></i> Menunggu Konfirmasi</span>`
                    : `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"><i class="fas fa-check-circle"></i> Selesai</span>`;
                
                const actionBtn = isPending 
                    ? `<button onclick="confirmOrder('${o.id}')" class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold shadow transition flex justify-center items-center gap-2"><i class="fas fa-check"></i> Terima Pesanan</button>` 
                    : ``;

                container.innerHTML += `
                    <div class="border border-gray-200 p-4 rounded-xl mb-4 bg-white shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100">
                            <div>
                                <span class="font-bold text-gray-800 block">${o.buyerName}</span>
                                <span class="text-xs text-gray-400">#${o.id.substr(0,5)} ‚Ä¢ ${new Date(o.date).toLocaleTimeString()}</span>
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg mb-3">
                            ${itemHtml}
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Total Tagihan</span>
                            <span class="font-bold text-lg text-primary">${formatRupiah(o.total)}</span>
                        </div>
                        ${actionBtn}
                    </div>
                `;
            });
        }

        function confirmOrder(orderId) {
            let orders = loadData(DB_KEYS.ORDERS);
            const idx = orders.findIndex(o => o.id === orderId);
            if(idx > -1) {
                orders[idx].status = 'completed';
                saveData(DB_KEYS.ORDERS, orders);
                renderSellerOrders();
                updateIncomingOrdersBadge();
            }
        }

        function updateIncomingOrdersBadge() {
            if (!state.user || state.user.role !== 'penjual') return;
            const orders = loadData(DB_KEYS.ORDERS).filter(o => o.sellerId === state.user.id && o.status === 'pending');
            const badge = getEl('incoming-order-badge');
            
            // Calculate revenue
            const allMyOrders = loadData(DB_KEYS.ORDERS).filter(o => o.sellerId === state.user.id && o.status === 'completed');
            const totalRev = allMyOrders.reduce((sum, o) => sum + o.total, 0);
            
            const revEl = getEl('seller-revenue');
            if(revEl) revEl.innerText = `Omzet: ${formatRupiah(totalRev)}`;

            if (badge) {
                if (orders.length > 0) {
                    badge.classList.remove('hidden');
                    badge.innerText = orders.length;
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // --- BUYER FEATURES ---
        function renderBuyerMenu() {
            const products = loadData(DB_KEYS.PRODUCTS);
            const container = getEl('buyer-content');
            
            // Reset content
            container.innerHTML = '';
            container.className = "grid grid-cols-2 md:grid-cols-4 gap-4 pb-20"; // Grid mode

            if (products.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 opacity-50 flex flex-col items-center">
                    <i class="fas fa-store-slash text-5xl mb-4"></i>
                    <p>Kantin sedang tutup atau menu kosong.</p>
                </div>`;
                return;
            }

            products.forEach(p => {
                // Check stock
                if (p.stock <= 0) return;

                const card = document.createElement('div');
                card.className = `card p-0 rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 product-item category-${p.category} bg-white group`;
                card.innerHTML = `
                    <div class="h-40 bg-gray-100 relative overflow-hidden">
                         ${p.image ? `<img src="${p.image}" onerror="this.onerror=null; this.src='https://placehold.co/160x160/cccccc/333333?text=Menu';" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">` : 
                         `<div class="w-full h-full flex items-center justify-center text-4xl bg-gray-50">üçî</div>`}
                         <div class="absolute top-2 right-2 bg-white/90 backdrop-blur-sm px-2 py-0.5 rounded-full text-xs font-bold shadow text-gray-700 border border-gray-200">
                             ${p.stock} Tersedia
                         </div>
                         ${p.category === 'sehat' ? '<div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-0.5 rounded-full text-xs shadow flex items-center gap-1"><i class="fas fa-heart"></i> Sehat</div>' : ''}
                    </div>
                    <div class="p-4">
                        <div class="flex items-center gap-1 text-xs text-gray-500 mb-1">
                            <i class="fas fa-store"></i> ${p.sellerName}
                        </div>
                        <h3 class="font-bold text-gray-800 mb-2 truncate text-base group-hover:text-primary transition">${p.name}</h3>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-primary font-bold text-lg">${formatRupiah(p.price)}</span>
                            <button onclick="addToCart('${p.id}')" class="bg-primary hover:bg-opacity-90 text-white w-9 h-9 rounded-full flex items-center justify-center shadow-lg transform transition active:scale-90">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function filterMenu(category) {
            const items = document.querySelectorAll('.product-item');
            items.forEach(item => {
                if (category === 'all' || item.classList.contains(`category-${category}`)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        function addToCart(productId) {
            const products = loadData(DB_KEYS.PRODUCTS);
            const product = products.find(p => p.id === productId);
            
            const existing = state.cart.find(i => i.id === productId);
            if (existing) {
                if(existing.qty < product.stock) existing.qty++;
            } else {
                state.cart.push({ ...product, qty: 1 });
            }
            
            updateCartCount();
        }

        function updateCartCount() {
            const count = state.cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = getEl('cart-count');
            if(badge) {
                badge.innerText = count;
                badge.classList.remove('hidden');
                if(count === 0) badge.classList.add('hidden');
            }
        }

        function renderBuyerCart() {
            const container = getEl('buyer-content');
            container.className = "block pb-20 fade-in"; // List view
            
            if (state.cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-20 flex flex-col items-center">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-shopping-basket text-4xl text-gray-300"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-700">Keranjang Kosong</h3>
                        <p class="text-gray-500 mb-6">Yuk, pilih makanan sehatmu hari ini!</p>
                        <button onclick="renderBuyerMenu()" class="text-primary font-bold hover:underline">Kembali ke Menu</button>
                    </div>`;
                return;
            }

            let total = 0;
            const itemsHtml = state.cart.map(item => {
                const subtotal = item.price * item.qty;
                total += subtotal;
                return `
                    <div class="flex justify-between items-center border-b border-gray-100 py-4 last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="bg-gray-100 w-12 h-12 rounded flex items-center justify-center text-xl text-gray-400 font-bold">${item.qty}x</div>
                            <div>
                                <div class="font-bold text-gray-800">${item.name}</div>
                                <div class="text-xs text-gray-500">@ ${formatRupiah(item.price)}</div>
                            </div>
                        </div>
                        <div class="font-bold text-primary">${formatRupiah(subtotal)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="card p-6 rounded-xl shadow-lg max-w-lg mx-auto bg-white">
                    <h3 class="font-bold text-xl mb-6 border-b pb-4 text-gray-800"><i class="fas fa-receipt mr-2 text-primary"></i>Ringkasan Pesanan</h3>
                    <div class="mb-4">
                        ${itemsHtml}
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-bold text-gray-800">${formatRupiah(total)}</span>
                        </div>
                        <div class="flex justify-between items-center text-lg pt-2 border-t border-gray-200">
                            <span class="font-bold text-gray-800">Total Bayar</span>
                            <span class="font-bold text-xl text-primary">${formatRupiah(total)}</span>
                        </div>
                    </div>
                    
                    <div class="mb-6 space-y-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide">Metode Pembayaran</label>
                        <div class="relative">
                            <i class="fas fa-wallet absolute left-3 top-3 text-gray-400"></i>
                            <select id="payment-method" class="w-full p-2.5 pl-10 border rounded-lg bg-white outline-none focus:ring-2 focus:ring-primary appearance-none cursor-pointer">
                                <option value="cash">Tunai (Bayar di Kantin)</option>
                                <option value="balance">Saldo Kantin (Rp 50.000)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="state.cart=[]; updateCartCount(); renderBuyerMenu();" class="px-4 py-3 rounded-lg text-red-500 border border-red-200 hover:bg-red-50 font-semibold transition">Batal</button>
                        <button onclick="checkout()" class="btn-primary px-4 py-3 rounded-lg shadow-lg font-bold hover:shadow-xl transition transform active:scale-95">Pesan Sekarang</button>
                    </div>
                </div>
            `;
        }

        function checkout() {
            if (state.cart.length === 0) return;

            const ordersBySeller = {};
            state.cart.forEach(item => {
                if (!ordersBySeller[item.sellerId]) ordersBySeller[item.sellerId] = [];
                ordersBySeller[item.sellerId].push(item);
            });

            const orders = loadData(DB_KEYS.ORDERS);
            const products = loadData(DB_KEYS.PRODUCTS);

            Object.keys(ordersBySeller).forEach(sellerId => {
                const items = ordersBySeller[sellerId];
                const orderTotal = items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                
                const newOrder = {
                    id: generateId(),
                    buyerId: state.user.id,
                    buyerName: state.user.name,
                    sellerId: sellerId,
                    sellerName: items[0].sellerName,
                    items: items,
                    total: orderTotal,
                    status: 'pending',
                    date: new Date().toISOString()
                };

                orders.push(newOrder);

                items.forEach(cartItem => {
                    const prodIdx = products.findIndex(p => p.id === cartItem.id);
                    if (prodIdx > -1) {
                        products[prodIdx].stock -= cartItem.qty;
                    }
                });
            });

            saveData(DB_KEYS.ORDERS, orders);
            saveData(DB_KEYS.PRODUCTS, products);

            state.cart = [];
            updateCartCount();
            
            const app = getEl('app');
            app.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-center fade-in py-20">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600 text-4xl shadow-lg animate-bounce">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2 text-gray-800">Pesanan Berhasil!</h2>
                    <p class="text-gray-500 mb-8 max-w-md mx-auto">Pesanan Anda telah diteruskan ke penjual. Silakan tunggu konfirmasi atau langsung menuju kantin.</p>
                    <!-- FIX: Mengganti renderBuyerMenu() dengan renderView('buyer') untuk memastikan template div buyer-content dibuat ulang. -->
                    <button onclick="renderView('buyer')" class="btn-primary px-8 py-3 rounded-full shadow-lg font-bold hover:scale-105 transition">Kembali Belanja</button>
                </div>
            `;
        }

        function renderBuyerHistory() {
             const container = getEl('buyer-content');
             container.className = "block pb-20 fade-in";
             
             const myOrders = loadData(DB_KEYS.ORDERS).filter(o => o.buyerId === state.user.id).reverse();
             
             if(myOrders.length === 0) {
                 container.innerHTML = '<p class="text-center mt-10 opacity-50 flex flex-col items-center"><i class="fas fa-history text-4xl mb-2"></i>Belum ada riwayat pembelian.</p>';
                 return;
             }

             container.innerHTML = `<h3 class="font-bold text-xl mb-6 text-gray-800"><i class="fas fa-history mr-2"></i>Riwayat Pembelian</h3>` + myOrders.map(o => `
                <div class="card p-5 rounded-xl mb-4 bg-white shadow-sm border-l-4 ${o.status === 'completed' ? 'border-green-500' : 'border-yellow-500'} hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="font-bold text-gray-800"><i class="fas fa-store mr-1 text-gray-400"></i> ${o.sellerName}</div>
                            <div class="text-xs text-gray-500 mt-1">${new Date(o.date).toLocaleDateString()} ‚Ä¢ ${new Date(o.date).toLocaleTimeString()}</div>
                        </div>
                        <span class="text-xs px-3 py-1 rounded-full ${o.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} uppercase font-bold tracking-wide flex items-center gap-1">
                            ${o.status === 'completed' ? '<i class="fas fa-check-circle"></i> Selesai' : '<i class="fas fa-clock"></i> Diproses'}
                        </span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg mb-3">
                        ${o.items.map(i => `<div class="flex justify-between text-sm py-0.5"><span class="text-gray-600">${i.qty}x ${i.name}</span><span class="font-mono text-gray-500">${formatRupiah(i.price*i.qty)}</span></div>`).join('')}
                    </div>
                    <div class="flex justify-end items-center border-t pt-3">
                        <span class="text-sm text-gray-500 mr-2">Total:</span>
                        <span class="font-bold text-lg text-primary">${formatRupiah(o.total)}</span>
                    </div>
                </div>
             `).join('');
        }

        function renderLeaderboard() {
            let container;
            if (state.user.role === 'admin') container = getEl('admin-content');
            else if (state.user.role === 'penjual') container = getEl('seller-content');
            else { alert('Fitur ini hanya untuk Admin & Penjual'); return; }

            const orders = loadData(DB_KEYS.ORDERS);
            const sellerSales = {};

            orders.forEach(o => {
                if (!sellerSales[o.sellerId]) {
                    sellerSales[o.sellerId] = { name: o.sellerName, total: 0, count: 0 };
                }
                sellerSales[o.sellerId].total += o.total;
                sellerSales[o.sellerId].count += 1;
            });

            const sorted = Object.values(sellerSales).sort((a, b) => b.total - a.total).slice(0, 3);

            container.innerHTML = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">Papan Peringkat</h3>
                    <p class="text-sm text-gray-500">Penjual Terlaris Minggu Ini</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end max-w-4xl mx-auto">
                    ${sorted.length > 1 ? `
                    <div class="card p-6 rounded-xl shadow-lg text-center order-2 md:order-1 transform md:scale-90 bg-white border-t-4 border-gray-300 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-gray-300 text-white px-2 rounded-bl text-xs font-bold">2</div>
                        <div class="text-5xl mb-3">ü•à</div>
                        <div class="font-bold text-lg text-gray-800 truncate">${sorted[1].name}</div>
                        <div class="text-primary font-bold mt-1">${formatRupiah(sorted[1].total)}</div>
                        <div class="text-xs text-gray-400 mt-2">${sorted[1].count} Transaksi</div>
                    </div>` : ''}

                    ${sorted.length > 0 ? `
                    <div class="card p-8 rounded-xl shadow-2xl text-center order-1 md:order-2 border-t-4 border-yellow-400 bg-yellow-50 transform md:-translate-y-4 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-yellow-400 text-white px-3 py-1 rounded-bl text-sm font-bold">#1</div>
                        <div class="text-6xl mb-4 animate-bounce">ü•á</div>
                        <div class="font-bold text-2xl text-gray-900 truncate">${sorted[0].name}</div>
                        <div class="text-primary font-bold text-xl mt-2">${formatRupiah(sorted[0].total)}</div>
                        <div class="text-sm text-gray-500 mt-2 font-semibold bg-white rounded-full px-3 py-1 inline-block shadow-sm">${sorted[0].count} Transaksi</div>
                    </div>` : '<div class="col-span-3 text-center py-10 opacity-50">Belum ada data penjualan.</div>'}

                    ${sorted.length > 2 ? `
                    <div class="card p-6 rounded-xl shadow-lg text-center order-3 transform md:scale-90 bg-white border-t-4 border-orange-300 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-orange-300 text-white px-2 rounded-bl text-xs font-bold">3</div>
                        <div class="text-5xl mb-3">ü•â</div>
                        <div class="font-bold text-lg text-gray-800 truncate">${sorted[2].name}</div>
                        <div class="text-primary font-bold mt-1">${formatRupiah(sorted[2].total)}</div>
                        <div class="text-xs text-gray-400 mt-2">${sorted[2].count} Transaksi</div>
                    </div>` : ''}
                </div>
                
                ${state.user.role === 'penjual' ? '<div class="text-center mt-10"><button onclick="renderSellerOrders()" class="text-primary font-semibold hover:underline">Kembali ke Dashboard</button></div>' : ''}
            `;
        }

        init();
    </script>
</body>
</html>
